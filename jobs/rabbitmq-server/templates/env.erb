[ -z "$DEBUG" ] || set -x

export BOOTSTRAP_NODE="<%= "true" if spec.bootstrap %>"
export BOOTSTRAP_NODE_INSTANCE="<%= "#{spec.name}.0" %>"

export SERVICE_USER=vcap
export SERVICE_GROUP=vcap

# start installs the server, it can take a while
export MONIT_START_TIMEOUT=90

timeout_per_worker_process_type=30 # defined as WORKER_WAIT in https://github.com/rabbitmq/rabbitmq-common/blob/master/include/rabbit.hrl
number_of_worker_process_types=5   # connections
                                   # channels
                                   # queues
                                   # persistent message store
                                   # transient message store
export SERVICE_SHUTDOWN_TIMEOUT=$((timeout_per_worker_process_type * number_of_worker_process_types))

export RUN_DIR=/var/vcap/sys/run/rabbitmq-server
export RABBITMQ_PID_FILE="$RUN_DIR/pid"

export RABBITMQ_SERVER_PACKAGE=/var/vcap/jobs/rabbitmq-server/packages/rabbitmq-server
export RABBITMQ_SERVER_PACKAGE_URL="<%= p("rabbitmq-server.generic-unix-url") %>"

export RABBITMQ_MNESIA_BASE="<%= p("rabbitmq-server.mnesia_base") %>"
export RABBITMQ_LOG_BASE=/var/vcap/sys/log/rabbitmq-server
export RABBITMQ_CONFIG_FILE=/var/vcap/jobs/rabbitmq-server/rabbitmq
export RABBITMQ_PLUGINS_DIR="/var/vcap/jobs/rabbitmq-server/packages/rabbitmq-server/plugins:/var/vcap/jobs/rabbitmq-server/packages/rabbitmq-plugins"
export RABBITMQ_TRUST_STORE_DIR="<%= p("rabbitmq-trust-store.directory") %>"

export RABBITMQ_ADMIN_USER="<%= p("rabbitmq-server.admin_user") %>"
export RABBITMQ_ADMIN_PASS="<%= p("rabbitmq-server.admin_pass") %>"

export RABBITMQ_NODENAME="rabbit@<%= "#{spec.name}#{spec.index}-#{spec.deployment}" %>"
export RABBITMQ_CLUSTER_NAME="<%= spec.deployment %>"

export RABBITMQ_SCHEDULER_BIND_TYPE="<%= p("rabbitmq-server.scheduler_bind_type") %>"

export RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS="<%= p("rabbitmq-server.additional_erl_args") %>"
export RABBITMQ_DISTRIBUTION_BUFFER_SIZE="<%= p("rabbitmq-server.distribution_buffer_size") %>"

export RABBITMQ_SERVER_START_ARGS="-pa /var/vcap/jobs/rabbitmq-server/packages/looking_glass/ebin -pa /var/vcap/jobs/rabbitmq-server/packages/looking_glass/deps/lz4/ebin"

<%

etc_hosts = link("rabbitmq-server").instances.map do |i|
  "#{i.address} #{i.name}#{i.index}-#{spec.deployment}"
end

%>
export ETC_HOSTS="<%= etc_hosts.join("\n") %>"

export ERLANG_COOKIE="<%= p("erlang.cookie") %>"

# erl(1) / erlc(1) require $HOME to be set
# Default to the system user that runs rabbitmq-server
[ -n "$HOME" ] || export HOME=/home/vcap

export PATH="$RABBITMQ_SERVER_PACKAGE/sbin:/var/vcap/jobs/rabbitmq-server/packages/erlang-<%= p("erlang.version") %>/bin:/var/vcap/jobs/rabbitmq-server/bin:/var/vcap/jobs/rabbitmq-server/packages/rabbitmq-collect-env:$PATH"
