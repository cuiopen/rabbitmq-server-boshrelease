#!/usr/bin/env bash

set -e

# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/debug
# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/env

exec 1> >(tee -a "${RABBITMQ_LOG_BASE:?must be configure}/start.log") 2>&1

main() {
  date
  setup_run_dir
  setup_log_dir
  setup_mnesia_dir_and_parent_dir
  setup_trust_store_dir_and_parent_dir
  increase_file_descriptor_limit
  start
}

setup_run_dir() {
  mkdir -p "${RUN_DIR:?must be set}"
  chown -fR "${SERVICE_USER:?must be set}":"${SERVICE_GROUP:?must be set}" \
    "$RUN_DIR"
}

setup_log_dir() {
  mkdir -p "${RABBITMQ_LOG_BASE:?must be set}"
  chown -fR "$SERVICE_USER":"$SERVICE_GROUP" "$RABBITMQ_LOG_BASE"
}

setup_mnesia_dir_and_parent_dir() {
  mkdir -p "${RABBITMQ_MNESIA_BASE:?must be set}" "${RABBITMQ_MNESIA_BASE%/*}"
  chown -fR "$SERVICE_USER":"$SERVICE_GROUP" \
    "$RABBITMQ_MNESIA_BASE" "${RABBITMQ_MNESIA_BASE%/*}"
}

setup_trust_store_dir_and_parent_dir() {
  mkdir -p "${RABBITMQ_TRUST_STORE_DIR:?must be set}" "${RABBITMQ_TRUST_STORE_DIR%/*}"
  chown -fR "$SERVICE_USER":"$SERVICE_GROUP" \
    "$RABBITMQ_TRUST_STORE_DIR" "${RABBITMQ_TRUST_STORE_DIR%/*}"
}


increase_file_descriptor_limit() {
  ulimit -n 100000
}

start() {
  ERL_CRASH_DUMP="$RABBITMQ_LOG_BASE/erl_crash-$(date +'%Y%m%d_%H%M%S').dump" \
  RABBITMQ_IGNORE_SIGINT=false \
  RUNNING_UNDER_SYSTEMD=true \
  /var/vcap/jobs/rabbitmq-server/packages/start-stop-daemon*/start-stop-daemon \
    --pidfile "${RABBITMQ_PID_FILE:?must be set}" \
    --chuid "$SERVICE_USER":"$SERVICE_GROUP" \
    --start --oknodo --background \
    --exec "${RABBITMQ_SERVER_PACKAGE:?must be set}/sbin/rabbitmq-server" --name beam
}

main
