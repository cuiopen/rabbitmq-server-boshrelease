#!/usr/bin/env bash

set -e

# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/debug
# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/env

exec 1> >(tee -a "${RABBITMQ_LOG_BASE:?must be defined}/start.log") 2>&1

main() {
  date
  setup_directories
  increase_file_descriptor_limit
  start
}

setup_directories() {
  mkdir -p \
    "${RUN_DIR:?must be defined}" \
    "${RABBITMQ_LOG_BASE:?must be defined}" \
    "${RABBITMQ_MNESIA_BASE:?must be defined}" \
    "${RABBITMQ_TRUST_STORE_DIRECTORY:?must be defined}"

  chown "${SERVICE_USER:?must be defined}":"${SERVICE_GROUP:?must be defined}" \
    "$RUN_DIR" \
    "$RABBITMQ_LOG_BASE" \
    "$RABBITMQ_MNESIA_BASE" \
    "$RABBITMQ_TRUST_STORE_DIRECTORY"
}

increase_file_descriptor_limit() {
  ulimit -n 100000
}

start() {
  RUNNING_UNDER_SYSTEMD=true /sbin/start-stop-daemon \
    --pidfile "${RABBITMQ_PID_FILE:?must be defined}" \
    --chuid "$SERVICE_USER":"$SERVICE_GROUP" \
    --start --oknodo --background \
    --exec "${RABBITMQ_SERVER_PACKAGE:?must be defined}/sbin/rabbitmq-server" --name beam
}

main
