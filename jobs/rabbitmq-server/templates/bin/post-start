#!/usr/bin/env bash

set -e

# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/debug
# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/env

main() {
  date
  if [ -n "${BOOTSTRAP_NODE?must be defined}" ]
  then
    set_cluster_name
    delete_guest_user
    add_admin_user
    grant_privileges_to_admin_user
  else
    echo "$0 will only run on the bootstrap node, ${BOOTSTRAP_NODE_INSTANCE:?must be set}"
  fi
}

set_cluster_name() {
  rabbitmqctl set_cluster_name "${RABBITMQ_CLUSTER_NAME:?must be set}"
}

delete_guest_user() {
  rabbitmqctl delete_user guest || true
}

ensure_admin_user_can_authenticate() {
  rabbitmqctl authenticate_user \
    "${RABBITMQ_ADMIN_USER:?must be set}" \
    "${RABBITMQ_ADMIN_PASS:?must be set}"
}

add_admin_user() {
  ensure_admin_user_can_authenticate ||
  (
    rabbitmqctl add_user "$RABBITMQ_ADMIN_USER" "$RABBITMQ_ADMIN_PASS" ||
    rabbitmqctl change_password "$RABBITMQ_ADMIN_USER" "$RABBITMQ_ADMIN_PASS"
  )

  ensure_admin_user_can_authenticate
}

grant_privileges_to_admin_user() {
  rabbitmqctl set_user_tags "$RABBITMQ_ADMIN_USER" administrator
  rabbitmqctl set_permissions -p / "$RABBITMQ_ADMIN_USER" ".*" ".*" ".*"
}

main
