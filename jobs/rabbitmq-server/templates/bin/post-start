#!/usr/bin/env bash

set -e

# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/debug
# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/env

main() {
  date
  set_cluster_name
  delete_guest_user
  add_admin_user
}

set_cluster_name() {
  rabbitmqctl set_cluster_name "${RABBITMQ_CLUSTER_NAME:?must be set}"
}

delete_guest_user() {
  rabbitmqctl delete_user guest || true
}

authenticate_admin_user() {
  rabbitmqctl authenticate_user \
    "${RABBITMQ_ADMIN_USER:?must be set}" \
    "${RABBITMQ_ADMIN_PASS:?must be set}"
}

add_admin_user() {
  authenticate_admin_user ||
  (
    rabbitmqctl add_user \
      "$RABBITMQ_ADMIN_USER" \
      "$RABBITMQ_ADMIN_PASS"

    rabbitmqctl set_user_tags "$RABBITMQ_ADMIN_USER" administrator
  )

  authenticate_admin_user
}

main
