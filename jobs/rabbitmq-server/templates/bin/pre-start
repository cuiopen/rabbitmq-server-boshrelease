#!/usr/bin/env bash

set -e

# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/debug
# shellcheck source=/dev/null
. /var/vcap/jobs/rabbitmq-server/env

main() {
  date
  install_generic_unix_package
  add_rabbitmq_server_env_to_global_shell_profile
  enable_all_plugins
}

install_generic_unix_package() {
  true "${RABBITMQ_SERVER_PACKAGE_URL:?must be set}"

  (
    local archive package_dir _version
    archive="${RABBITMQ_SERVER_PACKAGE_URL##*/}"
    _version="${RABBITMQ_SERVER_PACKAGE_URL##*generic-unix-}"
    package_dir="rabbitmq_server-${_version%%.tar.*z}"

    cd /var/vcap/jobs/rabbitmq-server/packages

    if [ -d "$package_dir" ]
    then
      echo "$package_dir already exists, nothing to download"
    else
      [ -f "$archive" ] ||
        curl --connect-timeout 3 --max-time $((3 * 60)) -svL -o "$archive" "$RABBITMQ_SERVER_PACKAGE_URL"

      case "$archive" in
        *.tar.gz)
          tar xzf "$archive"
        ;;
        *.tar.xz)
          tar xJf "$archive"
        ;;
        *)
          echo "$archive is not supported"
          return 1
        ;;
      esac
    fi

    ln -nsf "$package_dir" "${RABBITMQ_SERVER_PACKAGE:?must be set}"
  )
}

add_rabbitmq_server_env_to_global_shell_profile() {
  cat > /etc/profile.d/rabbitmq-server-env.sh <<EOF
. /var/vcap/jobs/rabbitmq-server/env
EOF
}

enable_all_plugins() {
  # shellcheck disable=SC2046
  rabbitmq-plugins enable $(rabbitmq-plugins list -m) --offline
}

main
