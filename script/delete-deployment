#!/usr/bin/env bash

set -e

[ -z "$DEBUG" ] || set -x

LASTPASS_BOSH_DIRECTOR_CREDENTIALS="Shared-London Services/london-ci/bosh-env-tarantino"

main() {
  ensure_logged_in
  delete_deployment
  delete_deployment_files
}

ensure_logged_in() {
  bosh stemcells &>/dev/null ||
  bosh login "$(bosh_username)" "$(bosh_password)"
}

bosh_username() {
  lpass show --username "$LASTPASS_BOSH_DIRECTOR_CREDENTIALS"
}

bosh_password() {
  lpass show --password "$LASTPASS_BOSH_DIRECTOR_CREDENTIALS"
}

deployment_exists() {
  [ -f deployment ]
}

delete_deployment() {
  if deployment_exists
  then
    . deployment
    bosh delete deployment "$DEPLOYMENT_NAME"
  else
    echo "It doesn't seem that you have deployed using script/create-deployment, no deployment to delete"
  fi
}

delete_deployment_files() {
  rm -f manifest.yml
  while true; do
    read -p "Do you want to delete a deployment file [yn]? " yn
    case $yn in
      [Yy]* ) rm -f deployment
              break;;
      [Nn]* ) exit;;
      * ) echo "Please answer y or n.";;
    esac
  done
}

main
