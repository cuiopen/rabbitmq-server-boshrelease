#!/usr/bin/env bash

set -e

[ -z "$DEBUG" ] || set -x

LASTPASS_BOSH_DIRECTOR_CREDENTIALS="Shared-London Services/london-ci/bosh-env-tarantino"

BOSH_DIRECTOR_FQDN="tarantino.directors.cf-app.com"

main() {
  bosh_target
  if manifest_exists
  then
    . deployment
    upload_stemcell
    upload_latest_final_release
    bosh deployment manifest.yml
    bosh deploy --no-redact
    ok
  else
    suggest_creating_manifest_first
  fi
}

bosh_target() {
  bosh target "https://$BOSH_DIRECTOR_FQDN:25555"
  bosh login "$(bosh_username)" "$(bosh_password)"
}

bosh_username() {
  lpass show --username "$LASTPASS_BOSH_DIRECTOR_CREDENTIALS"
}

bosh_password() {
  lpass show --password "$LASTPASS_BOSH_DIRECTOR_CREDENTIALS"
}

manifest_exists() {
  [ -f deployment ] && [ -f manifest.yml ]
}

suggest_creating_manifest_first() {
  echo "It doesn't seem that you have created a manifest, you may want to first run script/create-manifest"
  return 1
}

upload_stemcell() {
  if [ -z "$BOSH_STEMCELL_NAME" ] || [ -z "$BOSH_STEMCELL_VERSION" ] || [ -z "$BOSH_STEMCELL_VERSION_SHA1" ]
  then
    echo "
Deployment properties & manifests are now generated differently
You must create a new manifest via ./script/create-manifest before you can run this script"
    exit 1
  else
    bosh upload stemcell "https://bosh.io/d/stemcells/$BOSH_STEMCELL_NAME?v=$BOSH_STEMCELL_VERSION" \
      --name "$BOSH_STEMCELL_NAME" \
      --version "$BOSH_STEMCELL_VERSION" --sha1 "$BOSH_STEMCELL_VERSION_SHA1" \
      --skip-if-exists
  fi
}

upload_latest_final_release() {
  local final_releases latest_final_release_manifest
  final_releases=(releases/*/*.yml)
  latest_final_release_manifest="${final_releases[*]: -1}"

  bosh upload release "$latest_final_release_manifest"
}

ok() {
  echo "
${RMQ_PACKAGE##*/} deployed on $NODES_COUNT x $NODES_TYPE

  URL:  https://$DEPLOYMENT_NAME.$BOSH_DIRECTOR_FQDN/
  USER: $SERVER_USER
  PASS: $SERVER_PASS

To SSH into any of the RabbitMQ node(s):

  cd ../rabbitmq-credentials/bosh
  git pull
  ./ssh
"
  bosh instances --ps
}

main
