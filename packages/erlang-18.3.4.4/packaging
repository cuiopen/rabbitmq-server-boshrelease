#!/usr/bin/env bash

set -ex

DISABLED_APPLICATIONS=(debugger et gs jinterface observer odbc wx)

main() {
  extract_archive
  compile
}

extract_archive() {
  tar xzf erlang*/*.tgz
}

compile() {
  cd otp*

  # Disable Erlang applications we don't care about.
  # This is now supported through ./configure since at least 19.2.3 (possibly earlier)
  local app
  for app in "${DISABLED_APPLICATIONS[@]}"; do
    echo > "lib/$app/SKIP"
    rm -f "lib/$app/configure"
    configure_flags="$configure_flags --without-$app"
  done

  # erl(1)/erlc(1) require $HOME to be set.
  export HOME=/tmp

  # shellcheck disable=2086
  ./configure --prefix="${BOSH_INSTALL_TARGET:?must be defined}" \
    --enable-hipe \
    --disable-sctp \
    $configure_flags
  make -j "$(getconf _NPROCESSORS_ONLN)"
  make install
}

main
